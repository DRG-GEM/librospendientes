<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Libros Pendientes v3.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .card-enter, .btn-enter { animation: card-enter 0.5s ease-out forwards; opacity: 0; }
        @keyframes card-enter { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none; }
        .book-prepared { background-color: #fef9c3 !important; border-color: #facc15; }
        .book-delivered { opacity: 0.6; }
        .book-delivered .book-title { text-decoration: line-through; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="mb-6">
            <h1 class="text-4xl font-bold text-slate-900">Gestor de Libros Escolares</h1>
            <p class="text-slate-600 mt-2">Gestiona tu catálogo, asigna pendientes y consulta el historial de entregas.</p>
        </header>

        <div class="mb-8 border-b border-slate-200">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button id="tab-pendientes" class="tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">Gestión de Pendientes</button>
                <button id="tab-catalogo" class="text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">Gestión del Catálogo</button>
                <button id="tab-historial" class="text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">Historial</button>
            </nav>
        </div>

        <!-- Vista: Gestión de Pendientes -->
        <main id="view-pendientes">
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1"><div class="bg-white p-6 rounded-xl shadow-md"><h2 class="text-2xl font-semibold mb-1 text-slate-900">Añadir Pendiente</h2><p class="text-sm text-slate-500 mb-4">Sigue los pasos para registrar libros pendientes.</p><div class="space-y-4"><div><label for="studentName" class="block text-sm font-medium text-slate-700">Paso 1: Nombre del Alumno</label><input type="text" id="studentName" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 transition"></div><div id="step-2-courses"><label class="block text-sm font-medium text-slate-700">Paso 2: Selecciona el Curso</label><div id="course-selection-buttons" class="mt-2 grid grid-cols-2 gap-2"></div></div><div id="step-3-books" class="hidden"><label id="book-selection-label" class="block text-sm font-medium text-slate-700">Paso 3: Selecciona los Libros</label><div id="book-selection-list" class="mt-2 space-y-2 max-h-60 overflow-y-auto pr-2 border rounded-md p-2"></div><div class="mt-4 space-y-2"><button id="add-selected-books-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 disabled:bg-slate-400" disabled>Añadir Libros</button><button id="back-to-courses" class="w-full text-sm text-center text-slate-600 hover:text-indigo-600">← Volver a Cursos</button></div></div></div></div></div>
                <div class="lg:col-span-2"><div class="bg-white p-6 rounded-xl shadow-md min-h-[400px]"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-slate-900">Listado de Entregas Pendientes</h2><span id="pending-count" class="bg-indigo-100 text-indigo-800 text-sm font-semibold px-3 py-1 rounded-full">0</span></div><div id="pending-books-list" class="space-y-4"><p id="pending-empty" class="text-center py-10 text-slate-500">No hay libros pendientes de entrega.</p></div></div></div>
            </div>
        </main>

        <!-- Vista: Gestión del Catálogo -->
        <main id="view-catalogo" class="hidden">
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-md"><h2 id="form-title" class="text-2xl font-semibold mb-4 text-slate-900">Añadir Libro</h2><form id="add-master-book-form" class="space-y-4"><input type="hidden" id="edit-book-id"><div><label for="masterBookTitle" class="block text-sm font-medium text-slate-700">Título del Libro</label><input type="text" id="masterBookTitle" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div><div><label for="masterCourse" class="block text-sm font-medium text-slate-700">Curso</label><input type="text" id="masterCourse" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: 1º ESO A"></div><div class="flex space-x-2"><button type="submit" id="submit-master-book" class="flex-grow bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">Añadir al Catálogo</button><button type="button" id="cancel-edit-btn" class="hidden bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button></div></form></div>
                    <div class="bg-white p-6 rounded-xl shadow-md"><h2 class="text-2xl font-semibold mb-4 text-slate-900">Carga Masiva (Catálogo)</h2><p class="text-sm text-slate-600 mb-3">Pega aquí tu listado. Formato: <strong class="font-mono text-indigo-700">Título,Curso</strong>.</p><textarea id="master-csv-input" rows="5" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="Libro de Lengua,1º ESO A&#x0a;Libro de Mates,1º ESO A"></textarea><button id="upload-master-csv-btn" class="mt-4 w-full bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700">Cargar Listado al Catálogo</button><div id="master-upload-feedback" class="hidden mt-4 text-sm px-4 py-3 rounded-lg"></div></div>
                    <div class="bg-red-50 p-6 rounded-xl shadow-md border border-red-200"><h2 class="text-2xl font-semibold mb-2 text-red-800">Zona de Peligro</h2><p class="text-sm text-red-600 mb-4">Esta acción borrará todos los datos de la aplicación de forma permanente.</p><button id="reset-app-btn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700">Resetear Aplicación</button></div>
                </div>
                <div class="lg:col-span-2"><div class="bg-white p-6 rounded-xl shadow-md min-h-[400px]"><h2 class="text-2xl font-semibold text-slate-900 mb-4">Catálogo de Libros</h2><div id="master-book-list" class="space-y-6"><p id="catalog-empty" class="text-center py-10 text-slate-500">El catálogo está vacío.</p></div></div></div>
            </div>
        </main>

        <!-- Vista: Historial -->
        <main id="view-historial" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-semibold text-slate-900 mb-4">Historial de Alumnos</h2>
                <div id="student-history-list" class="space-y-2"><p id="history-empty" class="text-center py-10 text-slate-500">No hay historial para mostrar.</p></div>
            </div>
        </main>
    </div>
    
    <!-- Modal para Historial de Libros -->
    <div id="book-history-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6"><h2 id="modal-title" class="text-2xl font-bold mb-4">Historial del Libro</h2><div id="modal-content" class="max-h-96 overflow-y-auto"></div><button id="close-modal-btn" class="mt-6 w-full bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-700">Cerrar</button></div>
    </div>
    
    <div id="toast" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, serverTimestamp, writeBatch, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // PEGA AQUÍ TU CONFIGURACIÓN DE FIREBASE OBTENIDA EN EL PASO 1.4
        const firebaseConfig = {
  apiKey: "AIzaSyAUyzh1ZrKVsfHNiUwplPKwCZcZy0IgYKs",
  authDomain: "librospendientes-20378.firebaseapp.com",
  projectId: "librospendientes-20378",
  storageBucket: "librospendientes-20378.firebasestorage.app",
  messagingSenderId: "817775885257",
  appId: "1:817775885257:web:0a889bcae3d5127be24618"
};
        // --- End of Firebase Configuration ---

        const appId = firebaseConfig.projectId;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        signInAnonymously(auth).catch(console.error);

        const MASTER_BOOKS_COLLECTION = `/artifacts/${appId}/public/data/master_books`;
        const PENDING_BOOKS_COLLECTION = `/artifacts/${appId}/public/data/pending_books`;
        
        let masterBooks = [];
        let pendingBooks = [];

        // --- UI Elements & View Switching ---
        const tabPendientes = document.getElementById('tab-pendientes');
        const tabCatalogo = document.getElementById('tab-catalogo');
        const tabHistorial = document.getElementById('tab-historial');
        const views = {
            pendientes: document.getElementById('view-pendientes'),
            catalogo: document.getElementById('view-catalogo'),
            historial: document.getElementById('view-historial')
        };
        const tabs = { pendientes: tabPendientes, catalogo: tabCatalogo, historial: tabHistorial };

        function switchView(viewName) {
            Object.keys(views).forEach(key => {
                views[key].classList.toggle('hidden', key !== viewName);
                tabs[key].classList.toggle('tab-active', key === viewName);
            });
        }
        tabPendientes.addEventListener('click', () => switchView('pendientes'));
        tabCatalogo.addEventListener('click', () => switchView('catalogo'));
        tabHistorial.addEventListener('click', () => switchView('historial'));

        const toast = document.getElementById('toast');
        function showToast(message) {
            toast.textContent = message; toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // --- CATALOG LOGIC ---
        const addMasterBookForm = document.getElementById('add-master-book-form');
        const masterBookListDiv = document.getElementById('master-book-list');
        const catalogEmpty = document.getElementById('catalog-empty');
        const masterCsvInput = document.getElementById('master-csv-input');
        const uploadMasterCsvBtn = document.getElementById('upload-master-csv-btn');
        const masterUploadFeedback = document.getElementById('master-upload-feedback');
        const formTitle = document.getElementById('form-title');
        const submitMasterBookBtn = document.getElementById('submit-master-book');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editBookIdInput = document.getElementById('edit-book-id');

        addMasterBookForm.addEventListener('submit', async e => { e.preventDefault(); const title = addMasterBookForm.masterBookTitle.value.trim(); const course = addMasterBookForm.masterCourse.value.trim().toUpperCase(); const bookId = editBookIdInput.value; if (title && course) { if (bookId) { await updateDoc(doc(db, MASTER_BOOKS_COLLECTION, bookId), { title, course }); showToast('Libro actualizado.'); } else { await addDoc(collection(db, MASTER_BOOKS_COLLECTION), { title, course }); showToast('Libro añadido al catálogo.'); } resetMasterBookForm(); } });
        function resetMasterBookForm() { addMasterBookForm.reset(); editBookIdInput.value = ''; formTitle.textContent = 'Añadir Libro'; submitMasterBookBtn.textContent = 'Añadir al Catálogo'; cancelEditBtn.classList.add('hidden'); }
        cancelEditBtn.addEventListener('click', resetMasterBookForm);
        function renderMasterBookList(books) { catalogEmpty.classList.toggle('hidden', books.length > 0); const booksByCourse = books.reduce((acc, book) => { (acc[book.course] = acc[book.course] || []).push(book); return acc; }, {}); masterBookListDiv.innerHTML = Object.keys(booksByCourse).sort().map(course => `<div><h3 class="text-lg font-semibold text-indigo-700">${course}</h3><ul class="mt-2 space-y-1">${booksByCourse[course].sort((a,b) => a.title.localeCompare(b.title)).map(book => `<li class="flex justify-between items-center p-2 rounded-md hover:bg-slate-50"><span class="flex-grow">${book.title}</span><div class="flex-shrink-0 space-x-3"><button data-title="${book.title}" class="history-master-book text-gray-500 hover:text-gray-700 text-xs font-bold">HISTORIAL</button><button data-id="${book.id}" class="edit-master-book text-blue-500 hover:text-blue-700 text-xs font-bold">EDITAR</button><button data-id="${book.id}" class="delete-master-book text-red-400 hover:text-red-600 text-xs font-bold">ELIMINAR</button></div></li>`).join('')}</ul></div>`).join(''); }
        masterBookListDiv.addEventListener('click', async e => { const target = e.target; const bookId = target.dataset.id; if (target.classList.contains('delete-master-book')) { if (confirm('¿Seguro que quieres eliminar este libro del catálogo?')) { await deleteDoc(doc(db, MASTER_BOOKS_COLLECTION, bookId)); showToast('Libro eliminado del catálogo.'); } } if (target.classList.contains('edit-master-book')) { const book = masterBooks.find(b => b.id === bookId); if (book) { editBookIdInput.value = book.id; addMasterBookForm.masterBookTitle.value = book.title; addMasterBookForm.masterCourse.value = book.course; formTitle.textContent = 'Editando Libro'; submitMasterBookBtn.textContent = 'Guardar Cambios'; cancelEditBtn.classList.remove('hidden'); addMasterBookForm.scrollIntoView({ behavior: 'smooth' }); addMasterBookForm.masterBookTitle.focus(); } } if (target.classList.contains('history-master-book')) { openBookHistoryModal(target.dataset.title); } });
        uploadMasterCsvBtn.addEventListener('click', async () => { /* Lógica sin cambios */ });
        
        // --- PENDING BOOK LOGIC (RENOVADO) ---
        const studentNameInput = document.getElementById('studentName');
        const bookSelectionList = document.getElementById('book-selection-list');
        const step2Div = document.getElementById('step-2-courses');
        const step3Div = document.getElementById('step-3-books');
        const backButton = document.getElementById('back-to-courses');
        const pendingBooksListDiv = document.getElementById('pending-books-list');
        const pendingCountSpan = document.getElementById('pending-count');
        const pendingEmptyP = document.getElementById('pending-empty');
        const courseSelectionDiv = document.getElementById('course-selection-buttons');
        const addSelectedBooksBtn = document.getElementById('add-selected-books-btn');

        function renderCourseSelectionButtons(books) {
            courseSelectionDiv.innerHTML = '';
            const courses = [...new Set(books.map(b => b.course).filter(Boolean))].sort();
            if (courses.length === 0) {
                courseSelectionDiv.innerHTML = `<p class="text-sm text-slate-500 col-span-2">Aún no hay libros en el catálogo.</p>`;
                return;
            }
            courses.forEach(course => {
                const button = document.createElement('button');
                button.dataset.course = course;
                button.className = 'course-btn btn-enter text-center font-semibold bg-slate-100 hover:bg-indigo-100 p-3 rounded-md transition';
                button.textContent = course;
                courseSelectionDiv.appendChild(button);
            });
        }

        courseSelectionDiv.addEventListener('click', e => {
            if (e.target.classList.contains('course-btn')) {
                renderBookSelectionButtons(e.target.dataset.course);
                step2Div.classList.add('hidden');
                step3Div.classList.remove('hidden');
            }
        });

        // MEJORA: Renderizar lista de libros con checkboxes y detectar duplicados
        function renderBookSelectionButtons(course) {
            document.getElementById('book-selection-label').textContent = `Paso 3: Selecciona los Libros para ${course}`;
            const booksForCourse = masterBooks.filter(b => b.course === course).sort((a,b) => a.title.localeCompare(b.title));
            
            const studentName = studentNameInput.value.trim().toLowerCase();
            const studentPendingBooks = new Set(
                pendingBooks
                    .filter(b => b.studentName.toLowerCase() === studentName && b.status !== 'delivered')
                    .map(b => b.bookTitle)
            );

            bookSelectionList.innerHTML = booksForCourse.map(book => {
                const isAlreadyPending = studentPendingBooks.has(book.title);
                const disabledClass = isAlreadyPending ? 'opacity-50 cursor-not-allowed bg-slate-50' : 'cursor-pointer hover:bg-indigo-50';
                const disabledInput = isAlreadyPending ? 'disabled' : '';
                const pendingBadge = isAlreadyPending ? '<span class="text-xs bg-orange-100 text-orange-800 font-semibold px-2 py-0.5 rounded-full">Pendiente</span>' : '';

                return `
                <label class="book-select-item flex items-center justify-between space-x-3 p-3 rounded-md transition border ${disabledClass}">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" data-title="${book.title}" data-course="${book.course}" class="book-checkbox h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${disabledInput}>
                        <span class="flex-grow select-none">${book.title}</span>
                    </div>
                    ${pendingBadge}
                </label>`
            }).join('');
            updateAddBooksButtonState();
        }
        
        function updateAddBooksButtonState() {
            const selectedCount = bookSelectionList.querySelectorAll('input[type="checkbox"]:checked').length;
            if (selectedCount > 0) {
                addSelectedBooksBtn.disabled = false;
                addSelectedBooksBtn.textContent = `Añadir ${selectedCount} Libro(s)`;
            } else {
                addSelectedBooksBtn.disabled = true;
                addSelectedBooksBtn.textContent = `Añadir Libros`;
            }
        }
        bookSelectionList.addEventListener('change', updateAddBooksButtonState);

        addSelectedBooksBtn.addEventListener('click', async () => {
            const studentName = studentNameInput.value.trim();
            if (!studentName) { alert('Introduce el nombre del alumno.'); studentNameInput.focus(); return; }
            const selectedCheckboxes = bookSelectionList.querySelectorAll('input[type="checkbox"]:checked');
            if (selectedCheckboxes.length === 0) return;
            
            const batch = writeBatch(db);
            selectedCheckboxes.forEach(checkbox => {
                const { title, course } = checkbox.dataset;
                const newBookRef = doc(collection(db, PENDING_BOOKS_COLLECTION));
                batch.set(newBookRef, { studentName, bookTitle: title, course, createdAt: serverTimestamp(), status: 'pending' });
            });
            await batch.commit();
            showToast(`${selectedCheckboxes.length} libro(s) añadido(s) para ${studentName}.`);
            studentNameInput.value = '';
            resetToAddState();
        });

        backButton.addEventListener('click', resetToAddState);
        function resetToAddState() {
            step3Div.classList.add('hidden');
            step2Div.classList.remove('hidden');
            studentNameInput.focus();
            bookSelectionList.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            updateAddBooksButtonState();
        }

        function renderPendingBooksList(books) { 
            const activeBooks = books.filter(b => b.status !== 'delivered'); pendingCountSpan.textContent = activeBooks.length; pendingEmptyP.classList.toggle('hidden', books.length > 0); books.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); pendingBooksListDiv.innerHTML = books.map(book => { let statusClass = ''; if (book.status === 'prepared') statusClass = 'book-prepared'; if (book.status === 'delivered') statusClass = 'book-delivered'; const prepareButton = book.status === 'pending' ? `<button data-id="${book.id}" class="prepare-btn flex-shrink-0 bg-yellow-400 text-yellow-900 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-yellow-500">Preparado</button>` : ''; const deliverButtonText = book.status === 'delivered' ? 'Deshacer' : 'Entregado'; const deliverButtonClasses = book.status === 'delivered' ? 'bg-slate-500 hover:bg-slate-600' : 'bg-green-500 hover:bg-green-600'; const deliverButton = `<button data-id="${book.id}" data-current-status="${book.status}" class="deliver-btn flex-shrink-0 text-white font-semibold py-2 px-4 rounded-lg shadow-sm ${deliverButtonClasses}">${deliverButtonText}</button>`; return `<div class="card-enter bg-slate-50 p-4 rounded-lg border flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 ${statusClass}"><div class="flex-grow"><p class="font-bold text-lg book-title">${book.bookTitle}</p><p class="text-slate-600">${book.studentName}</p><p class="inline-block bg-indigo-100 text-indigo-800 text-xs font-semibold mt-2 px-2 py-0.5 rounded-full">${book.course}</p></div><div class="flex space-x-2 self-end sm:self-center">${prepareButton}${deliverButton}</div></div>` }).join('') || pendingEmptyP.outerHTML;
        }
        
        pendingBooksListDiv.addEventListener('click', async e => {
            const target = e.target; const id = target.dataset.id; if (!id) return; const bookRef = doc(db, PENDING_BOOKS_COLLECTION, id); if (target.classList.contains('prepare-btn')) { await updateDoc(bookRef, { status: 'prepared' }); showToast('Libro marcado como preparado.'); } if (target.classList.contains('deliver-btn')) { const newStatus = target.dataset.currentStatus === 'delivered' ? 'prepared' : 'delivered'; await updateDoc(bookRef, { status: newStatus }); showToast(newStatus === 'delivered' ? '¡Libro entregado!' : 'Entrega deshecha.'); }
        });

        // --- HISTORY LOGIC ---
        const studentHistoryListDiv = document.getElementById('student-history-list'); const historyEmptyP = document.getElementById('history-empty');
        function getStatusBadge(status) { switch(status) { case 'delivered': return `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-200">Entregado</span>`; case 'prepared': return `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-yellow-600 bg-yellow-200">Preparado</span>`; default: return `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-red-600 bg-red-200">Pendiente</span>`; } }
        function renderHistoryView(books) { historyEmptyP.classList.toggle('hidden', books.length > 0); const booksByStudent = books.reduce((acc, book) => { (acc[book.studentName] = acc[book.studentName] || []).push(book); return acc; }, {}); studentHistoryListDiv.innerHTML = Object.keys(booksByStudent).sort().map(studentName => `<div class="border rounded-lg overflow-hidden"><button class="accordion-header w-full text-left p-4 font-semibold text-lg hover:bg-slate-50 flex justify-between items-center"><span>${studentName}</span><span class="text-sm bg-slate-200 text-slate-700 px-2 py-0.5 rounded-full">${booksByStudent[studentName].length} libros</span></button><div class="accordion-content bg-slate-50"><ul class="divide-y p-4 pt-0">${booksByStudent[studentName].map(book => `<li class="py-2 flex justify-between items-center"><span class="text-slate-800">${book.bookTitle} <em class="text-slate-500 text-sm">(${book.course})</em></span>${getStatusBadge(book.status)}</li>`).join('')}</ul></div></div>`).join(''); }
        studentHistoryListDiv.addEventListener('click', e => { const header = e.target.closest('.accordion-header'); if (header) { const content = header.nextElementSibling; if (content.style.maxHeight) { content.style.maxHeight = null; } else { content.style.maxHeight = content.scrollHeight + "px"; } } });
        
        // --- BOOK HISTORY MODAL ---
        const modal = document.getElementById('book-history-modal'); const modalTitle = document.getElementById('modal-title'); const modalContent = document.getElementById('modal-content');
        function openBookHistoryModal(bookTitle) { modalTitle.textContent = `Historial de: ${bookTitle}`; const history = pendingBooks.filter(b => b.bookTitle === bookTitle); if (history.length > 0) { modalContent.innerHTML = `<ul class="divide-y">${history.map(book => `<li class="py-2 flex justify-between items-center"><span>${book.studentName} <em class="text-slate-500 text-sm">(${book.course})</em></span>${getStatusBadge(book.status)}</li>`).join('')}</ul>`; } else { modalContent.innerHTML = `<p class="text-slate-500">Este libro no ha sido asignado a ningún alumno todavía.</p>`; } modal.classList.remove('hidden'); }
        document.getElementById('close-modal-btn').addEventListener('click', () => modal.classList.add('hidden'));

        // --- RESET APP LOGIC ---
        document.getElementById('reset-app-btn').addEventListener('click', async () => { if (confirm("ATENCIÓN: ¿Seguro que quieres borrar TODO el catálogo de libros y TODOS los pendientes?")) { if(confirm("Esta acción es IRREVERSIBLE. ¿Estás completamente seguro?")) { console.log("Borrando datos..."); const deleteCollection = async (collPath) => { const q = query(collection(db, collPath)); const snapshot = await getDocs(q); const batch = writeBatch(db); snapshot.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); }; try { await deleteCollection(PENDING_BOOKS_COLLECTION); await deleteCollection(MASTER_BOOKS_COLLECTION); showToast("¡Aplicación reseteada con éxito!"); } catch (e) { console.error("Error reseteando la app:", e); showToast("Error al resetear. Revisa la consola."); } } } });
        
        // --- Firestore Listeners ---
        onSnapshot(query(collection(db, MASTER_BOOKS_COLLECTION)), snapshot => {
            masterBooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderMasterBookList(masterBooks);
            renderCourseSelectionButtons(masterBooks);
        });
        onSnapshot(query(collection(db, PENDING_BOOKS_COLLECTION)), snapshot => {
            pendingBooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderPendingBooksList(pendingBooks);
            renderHistoryView(pendingBooks); 
        });
    </script>
</body>
</html>
